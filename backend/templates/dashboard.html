<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Analytics Dashboard - Industry Level</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <!-- Plotly JS -->
    <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
</head>

<body>

    <div class="app-shell">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">IA</div>
                <div class="sidebar-title">IoT Analytics</div>
            </div>

            <ul class="sidebar-nav">
                <li>
                    <a href="{{ url_for('dashboard') }}"
                        class="nav-item-btn {{ 'active' if active_page == 'dashboard' else '' }}">
                        <i class="bi bi-activity"></i>
                        <span class="nav-item-label">Live Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('devices') }}"
                        class="nav-item-btn {{ 'active' if active_page == 'devices' else '' }}">
                        <i class="bi bi-cpu"></i>
                        <span class="nav-item-label">Devices</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('alerts') }}"
                        class="nav-item-btn {{ 'active' if active_page == 'alerts' else '' }}">
                        <i class="bi bi-bell"></i>
                        <span class="nav-item-label">Alerts</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('trends') }}"
                        class="nav-item-btn {{ 'active' if active_page == 'trends' else '' }}">
                        <i class="bi bi-graph-up-arrow"></i>
                        <span class="nav-item-label">Trends</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('streaming') }}"
                        class="nav-item-btn {{ 'active' if active_page == 'streaming' else '' }}">
                        <i class="bi bi-broadcast"></i>
                        <span class="nav-item-label">Streaming</span>
                    </a>
                </li>
            </ul>

            <div class="sidebar-footer mt-3">
                <div class="d-flex align-items-center gap-2">
                    <div class="status-dot"></div>
                    <span class="sidebar-title">Streaming</span>
                </div>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <main class="main">
            <!-- TOP BAR -->
            <div class="topbar">
                <div class="topbar-left">
                    <h1>IoT Device Analytics</h1>
                    <div class="topbar-subtitle">
                        Real-time monitoring â€¢ Health scores â€¢ Intelligent alerts
                    </div>
                </div>
                <div class="topbar-right">
                    <span class="pill d-none d-md-inline-flex">
                        <i class="bi bi-clock-history me-1"></i>
                        Last refresh: <span id="last-refresh" class="ms-1">--</span>
                    </span>
                    <span class="pill d-none d-md-inline-flex">
                        <i class="bi bi-cloud-arrow-down me-1"></i>
                        Data source: Simulator
                    </span>
                    <span class="pill d-none d-md-inline-flex">
                        <i class="bi bi-person-circle me-1"></i>
                        {{ user.name if user and user.name else 'User' }}
                    </span>
                    <a class="btn btn-outline-light btn-sm ms-2" href="{{ url_for('logout') }}">Logout</a>
                </div>
            </div>
            <!-- SIMULATOR CONTROL PANEL -->
            <div class="container mb-4">
                <div class="card-panel control-card">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h5 class="mb-2" style="display: flex; align-items: center; gap: 10px;">
                                <i class="bi bi-rocket-takeoff" style="color: var(--accent); font-size: 24px;"></i>
                                Simulator Control Center
                            </h5>
                            <div id="sim-status" class="d-flex align-items-center gap-2" style="font-size: 14px;">
                                <span class="status-dot"></span>
                                <span class="text-secondary">Initializing...</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2" style="position: relative; z-index: 100;">
                            <button type="button" id="btn-start" onclick="startSim()" class="btn btn-success d-flex align-items-center gap-2" style="cursor: pointer; pointer-events: auto; position: relative; z-index: 101;">
                                <i class="bi bi-play-fill"></i> Start
                            </button>
                            <button type="button" id="btn-stop" onclick="stopSim()" class="btn btn-warning d-flex align-items-center gap-2" style="cursor: pointer; pointer-events: auto; position: relative; z-index: 101;">
                                <i class="bi bi-stop-fill"></i> Stop
                            </button>
                            <button type="button" id="btn-restart" onclick="restartSim()" class="btn btn-primary d-flex align-items-center gap-2" style="cursor: pointer; pointer-events: auto; position: relative; z-index: 101;">
                                <i class="bi bi-arrow-clockwise"></i> Restart
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- METRICS -->
            <div class="row g-3 mb-2">
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Active Devices</div>
                        <div class="metric-value" id="metric-devices">--</div>
                        <div class="metric-trend text-muted">
                            <i class="bi bi-router-fill me-1"></i>Connected sensors
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Avg Temperature</div>
                        <div class="metric-value" id="metric-temp">--</div>
                        <div class="metric-trend">
                            <i class="bi bi-thermometer-half me-1"></i>Process stability
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Alerts (last 5 min)</div>
                        <div class="metric-value" id="metric-alerts">--</div>
                        <div class="metric-trend text-warning">
                            <i class="bi bi-exclamation-triangle me-1"></i>Risk indicators
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Avg Health Score</div>
                        <div class="metric-value" id="metric-health">--</div>
                        <div class="metric-trend">
                            <span class="badge-soft-red">
                                <i class="bi bi-heart-pulse-fill me-1"></i>Machine health
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Offline Devices</div>
                        <div class="metric-value" id="metric-offline">--</div>
                        <div class="metric-trend text-danger">
                            <i class="bi bi-wifi-off me-1"></i>Connectivity gaps
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Anomaly Rate (5m)</div>
                        <div class="metric-value" id="metric-anomaly">--</div>
                        <div class="metric-trend text-warning">
                            <i class="bi bi-activity me-1"></i>Process deviations
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Recent Alerts (5m)</div>
                        <div class="metric-value" id="metric-recent-alerts">--</div>
                        <div class="metric-trend text-warning">
                            <i class="bi bi-broadcast me-1"></i>Live issues
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="metric-card">
                        <div class="metric-label">Data Freshness</div>
                        <div class="metric-value" id="metric-freshness">--</div>
                        <div class="metric-trend text-muted">
                            <i class="bi bi-arrow-repeat me-1"></i>Seconds since last event
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHARTS -->
            <div class="row g-3 mb-2">
                <div class="col-lg-6">
                    <div class="card-panel">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Temperature Trend</h6>
                                <div class="card-panel-sub">
                                    Live process temperature with recent rolling mean.
                                </div>
                            </div>
                        </div>
                        <div id="chart-temperature" class="chart-container"></div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card-panel">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Vibration Trend</h6>
                                <div class="card-panel-sub">
                                    High vibration often indicates early mechanical failure.
                                </div>
                            </div>
                        </div>
                        <div id="chart-vibration" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="card-panel">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Battery & Health</h6>
                                <div class="card-panel-sub">
                                    Power level vs. device health score over time.
                                </div>
                            </div>
                        </div>
                        <div id="chart-battery" class="chart-container"></div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card-panel alerts-card">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <h6>Alerts Stream</h6>
                                <div class="card-panel-sub">
                                    Overheat, vibration spikes, and battery-related anomalies.
                                </div>
                            </div>
                        </div>
                        <div id="alerts-table" class="mt-2 premium-alerts" style="max-height: 300px ;overflow-y: auto;
                        padding-right: 6px;">
                            <p class="text-secondary mb-0">Loading alerts...</p>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        async function fetchAnalytics() {
            const response = await fetch("/api/analytics", { credentials: "same-origin" });
            if (!response.ok) {
                throw new Error(`Analytics request failed (${response.status})`);
            }
            return response.json();
        }

        function updateMetrics(data) {
            const activeDevices = new Set(data.map(d => d.device_id)).size;

            const avgTemp = (
                data.reduce((sum, row) => sum + row.temperature, 0) / data.length
            ).toFixed(2);

            const alertsLast = data.filter(
                d => d.overheat || d.high_vibration || d.low_battery || d.battery_drop
            ).length;

            const avgHealth = (
                data.reduce((sum, row) => sum + row.health, 0) / data.length
            ).toFixed(1);

            const offlineDevices = new Set(data.filter(d => d.offline).map(d => d.device_id)).size;

            const recentAlerts = data.filter(d => d.recent_alert).length;

            const recentRows = data.filter(d => d.recent);
            const recentAnomalies = recentRows.filter(d => d.anomaly === true || d.anomaly === 1).length;
            
            // Debug logging (can be removed later)
            if (recentRows.length > 0) {
                const anomalyScores = recentRows.map(d => d.anomaly_score || 0).filter(s => s > 0);
                const maxScore = anomalyScores.length > 0 ? Math.max(...anomalyScores) : 0;
                console.log(`Anomaly Rate Debug: ${recentRows.length} recent rows, ${recentAnomalies} anomalies, max score: ${maxScore.toFixed(2)}`);
            }
            
            const anomalyRate = recentRows.length
                ? ((recentAnomalies / recentRows.length) * 100).toFixed(1)
                : "0.0";

            const latestTs = data.length ? new Date(data[data.length - 1].timestamp) : null;
            const freshnessSec = latestTs
                ? Math.max(0, Math.round((Date.now() - latestTs.getTime()) / 1000))
                : "--";

            document.getElementById("metric-devices").innerText = activeDevices;
            document.getElementById("metric-temp").innerText = avgTemp + "Â°C";
            document.getElementById("metric-alerts").innerText = alertsLast;
            document.getElementById("metric-health").innerText = avgHealth + "%";
            document.getElementById("metric-offline").innerText = offlineDevices;
            document.getElementById("metric-anomaly").innerText = anomalyRate + "%";
            document.getElementById("metric-recent-alerts").innerText = recentAlerts;
            document.getElementById("metric-freshness").innerText = freshnessSec + "s";

            const now = new Date();
            document.getElementById("last-refresh").innerText = now.toLocaleTimeString();
        }

        function basePlotLayout() {
            return {
                margin: { t: 20, r: 20, b: 40, l: 50 },
                paper_bgcolor: "rgba(0,0,0,0)",
                plot_bgcolor: "rgba(15,23,41,0.4)",
                font: {
                    color: "#f1f5f9",
                    family: "Inter, -apple-system, BlinkMacSystemFont, sans-serif",
                    size: 12
                },
                xaxis: {
                    gridcolor: "rgba(255,255,255,0.08)",
                    showgrid: true,
                    zeroline: false,
                    color: "#94a3b8"
                },
                yaxis: {
                    gridcolor: "rgba(255,255,255,0.08)",
                    showgrid: true,
                    zeroline: false,
                    color: "#94a3b8"
                },
                showlegend: true,
                legend: {
                    bgcolor: "rgba(15,23,41,0.8)",
                    bordercolor: "rgba(0,245,160,0.3)",
                    borderwidth: 1,
                    font: { size: 11, color: "#f1f5f9" },
                    x: 1,
                    xanchor: 'right',
                    y: 1
                },
                hovermode: 'x unified',
                hoverlabel: {
                    bgcolor: "rgba(15,23,41,0.95)",
                    bordercolor: "rgba(0,245,160,0.5)",
                    font: { size: 12, color: "#f1f5f9" }
                }
            };
        }

        function plotTemperature(data) {
            const trace = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.temperature),
                mode: "lines+markers",
                name: "Temperature",
                line: {
                    color: "#00d9ff",
                    width: 3,
                    shape: "spline"
                },
                marker: {
                    size: 6,
                    color: "#00d9ff",
                    line: {
                        color: "rgba(0, 217, 255, 0.3)",
                        width: 2
                    }
                },
                fill: 'tonexty',
                fillcolor: 'rgba(0, 217, 255, 0.1)'
            };

            const layout = basePlotLayout();
            layout.yaxis.title = "Temperature (Â°C)";

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot("chart-temperature", [trace], layout, config);
        }

        function plotVibration(data) {
            const trace = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.vibration),
                mode: "lines+markers",
                name: "Vibration",
                line: {
                    color: "#a78bfa",
                    width: 3,
                    shape: "spline"
                },
                marker: {
                    size: 6,
                    color: "#a78bfa",
                    line: {
                        color: "rgba(167, 139, 250, 0.3)",
                        width: 2
                    }
                },
                fill: 'tonexty',
                fillcolor: 'rgba(167, 139, 250, 0.1)'
            };

            const layout = basePlotLayout();
            layout.yaxis.title = "Vibration (g-force)";

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot("chart-vibration", [trace], layout, config);
        }

        function plotBatteryHealth(data) {
            const trace1 = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.battery),
                name: "Battery",
                mode: "lines+markers",
                line: {
                    color: "#00f5a0",
                    width: 3,
                    shape: "spline"
                },
                marker: {
                    size: 6,
                    color: "#00f5a0",
                    line: {
                        color: "rgba(0, 245, 160, 0.3)",
                        width: 2
                    }
                },
                fill: 'tonexty',
                fillcolor: 'rgba(0, 245, 160, 0.1)'
            };

            const trace2 = {
                x: data.map(d => d.timestamp),
                y: data.map(d => d.health),
                name: "Health",
                mode: "lines+markers",
                line: {
                    color: "#fbbf24",
                    width: 3,
                    shape: "spline",
                    dash: "dot"
                },
                marker: {
                    size: 6,
                    color: "#fbbf24",
                    line: {
                        color: "rgba(251, 191, 36, 0.3)",
                        width: 2
                    }
                }
            };

            const layout = basePlotLayout();
            layout.yaxis.title = "Percentage (%)";

            const config = {
                responsive: true,
                displayModeBar: false
            };

            Plotly.newPlot("chart-battery", [trace1, trace2], layout, config);
        }

        function renderAlertsTable(data) {

            // FILTER ONLY ALERT ENTRIES
            let alerts = data.filter(
                d => d.overheat || d.high_vibration || d.low_battery || d.battery_drop
            );

            // KEEP ONLY LATEST 10 ALERTS
            alerts = alerts.slice(-10).reverse();

            let html = `
    <table class="table table-dark table-hover table-striped">
        <thead>
            <tr>
                <th>Time</th>
                <th>Device</th>
                <th>Temp</th>
                <th>Vibration</th>
                <th>Battery</th>
                <th>Alerts</th>
            </tr>
        </thead>
        <tbody>
    `;

            alerts.forEach(row => {

                let alertTags = "";

                if (row.overheat)
                    alertTags += `<span class="alert-badge alert-critical">ðŸ”¥ Overheat</span>`;

                if (row.high_vibration)
                    alertTags += `<span class="alert-badge alert-warning">âš  Vibration</span>`;

                if (row.low_battery)
                    alertTags += `<span class="alert-badge alert-warning">ðŸ”‹ Low Battery</span>`;

                if (row.battery_drop)
                    alertTags += `<span class="alert-badge alert-info">â¬‡ Battery Drop</span>`;

                html += `
            <tr>
                <td>${row.timestamp}</td>
                <td>${row.device_id}</td>
                <td>${row.temperature}</td>
                <td>${row.vibration}</td>
                <td>${row.battery}</td>
                <td>${alertTags}</td>
            </tr>
        `;
            });

            html += "</tbody></table>";

            document.getElementById("alerts-table").innerHTML = html;
        }


        async function refreshDashboard() {
            try {
                const data = await fetchAnalytics();
                updateMetrics(data);
                plotTemperature(data);
                plotVibration(data);
                plotBatteryHealth(data);
                renderAlertsTable(data);
            } catch (e) {
                console.error("Dashboard refresh failed:", e);
            }
        }

        refreshDashboard();
        setInterval(refreshDashboard, 3000);

        // Initialize simulator status on page load
        updateSimStatus();
        setInterval(updateSimStatus, 2000);

        function renderSimError(message) {
            const indicator = document.getElementById("sim-status");
            if (!indicator) return;
            indicator.innerHTML = `
                <span class="status-dot status-offline"></span>
                <span style="color: #ff6b6b; font-weight: 700; font-size: 15px;">${message}</span>
            `;
        }

        async function startSim() {
            console.log("=== startSim() called ===");
            const btn = document.getElementById("btn-start");
            if (!btn) {
                console.error("Start button not found!");
                alert("Start button not found! Check console for details.");
                return;
            }
            const originalText = btn.innerHTML;
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';
                console.log("Starting simulator...");
                
                const response = await fetch("/sim/start", { 
                    method: "POST", 
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
                
                console.log("Start response status:", response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Start failed with response:", errorText);
                    throw new Error(`Start failed (${response.status}): ${errorText}`);
                }
                
                const data = await response.json();
                console.log("Start response data:", data);
                
                await updateSimStatus();
            } catch (error) {
                console.error("Failed to start simulator:", error);
                renderSimError("Start failed: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function stopSim() {
            console.log("=== stopSim() called ===");
            const btn = document.getElementById("btn-stop");
            if (!btn) {
                console.error("Stop button not found!");
                alert("Stop button not found! Check console for details.");
                return;
            }
            const originalText = btn.innerHTML;
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Stopping...';
                console.log("Stopping simulator...");
                
                const response = await fetch("/sim/stop", { 
                    method: "POST", 
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json"
                    }
                });
                
                console.log("Stop response status:", response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Stop failed with response:", errorText);
                    throw new Error(`Stop failed (${response.status}): ${errorText}`);
                }
                
                const data = await response.json();
                console.log("Stop response data:", data);
                
                await updateSimStatus();
            } catch (error) {
                console.error("Failed to stop simulator:", error);
                renderSimError("Stop failed: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function restartSim() {
            console.log("=== restartSim() called ===");
            const btn = document.getElementById("btn-restart");
            if (!btn) {
                console.error("Restart button not found!");
                alert("Restart button not found! Check console for details.");
                return;
            }
            const originalText = btn.innerHTML;
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Restarting...';
                console.log("Restarting simulator...");
                
                await stopSim();
                // Wait a bit longer to ensure stop completes
                await new Promise(resolve => setTimeout(resolve, 1000));
                await startSim();
            } catch (error) {
                console.error("Failed to restart simulator:", error);
                renderSimError("Restart failed: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function updateSimStatus() {
            try {
                const res = await fetch("/sim/status", { credentials: "same-origin" });
                if (!res.ok) throw new Error(`Status failed (${res.status})`);
                const data = await res.json();

                const indicator = document.getElementById("sim-status");
                if (!indicator) {
                    console.error("Status indicator not found!");
                    return;
                }

                if (data.running) {
                    indicator.innerHTML = `
                        <span class="status-dot status-online"></span>
                        <span style="color: #00f5a0; font-weight: 700; font-size: 15px;">System Running</span>
                    `;
                } else if (data.error) {
                    indicator.innerHTML = `
                        <span class="status-dot status-offline"></span>
                        <span style="color: #ff6b6b; font-weight: 700; font-size: 15px;">${data.error}</span>
                    `;
                } else {
                    indicator.innerHTML = `
                        <span class="status-dot status-offline"></span>
                        <span style="color: #ff6b6b; font-weight: 700; font-size: 15px;">System Stopped</span>
                    `;
                }
            } catch (error) {
                console.error("Failed to fetch status:", error);
                renderSimError("Unable to reach simulator");
            }
        }

        // Ensure functions are accessible globally (for onclick handlers)
        // Functions are already in global scope since they're not inside a closure
        console.log("Simulator control functions loaded:", {
            startSim: typeof startSim,
            stopSim: typeof stopSim,
            restartSim: typeof restartSim
        });

        // Alternative: Add event listeners as backup (in case onclick doesn't work)
        document.addEventListener('DOMContentLoaded', function() {
            const btnStart = document.getElementById("btn-start");
            const btnStop = document.getElementById("btn-stop");
            const btnRestart = document.getElementById("btn-restart");
            
            if (btnStart) {
                btnStart.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Start button clicked via event listener");
                    startSim();
                });
            }
            
            if (btnStop) {
                btnStop.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Stop button clicked via event listener");
                    stopSim();
                });
            }
            
            if (btnRestart) {
                btnRestart.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Restart button clicked via event listener");
                    restartSim();
                });
            }
            
            console.log("Event listeners attached to simulator control buttons");
        });

    </script>

</body>

</html>
